---
- name: Install certificate
  hosts: all
  remote_user: ubuntu
  vars:
    - email: hello@gear-tech.io

  tasks:
    - name: Install Nginx, certbot et al.
      become: yes
      apt:
        name: [nginx, certbot, python3-certbot-nginx]
        state: latest
        update_cache: yes

    - name: Start Nginx
      become: yes
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Create WWW directory
      become: yes
      file:
        path: /var/www/{{ inventory_hostname }}/html
        state: directory
        owner: www-data
        group: www-data
        mode: '0755'

    - name: Copy Nginx configuration
      become: yes
      template:
        src: server-block.j2
        dest: /etc/nginx/sites-available/{{ inventory_hostname }}

    - name: Enable Nginx configuration
      become: yes
      file:
        src: /etc/nginx/sites-available/{{ inventory_hostname }}
        dest: /etc/nginx/sites-enabled/{{ inventory_hostname }}
        state: link

    - name: Restart Nginx
      become: yes
      service:
        name: nginx
        state: restarted

    - name: Create and install the certificate
      become: yes
      command: >
        certbot --nginx
        -d {{ inventory_hostname }}
        -m {{ email }}
        --agree-tos --noninteractive --redirect
